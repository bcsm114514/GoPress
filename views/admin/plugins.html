<div class="space-y-8">
    
    <!-- é¡¶éƒ¨ -->
    <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h2 class="font-bold text-xl text-gray-800">æ’ä»¶ç®¡ç†</h2>
            <button onclick="reloadPlugins()" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                é‡è½½
            </button>
        </div>
        
        <form id="uploadForm" class="flex gap-2">
            <input type="file" name="plugin_zip" accept=".zip" class="hidden" id="zipInput" onchange="uploadPlugin()">
            <label for="zipInput" class="bg-black text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-800 transition cursor-pointer flex items-center gap-2 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                å®‰è£…æ’ä»¶ (.zip)
            </label>
        </form>
    </div>

    <!-- æ’ä»¶åˆ—è¡¨ -->
    <div class="grid grid-cols-1 gap-4">
        {{ range .Plugins }}
        <div class="bg-white border border-gray-200 rounded-lg p-5 flex items-start justify-between shadow-sm hover:shadow-md transition group">
            <div class="flex gap-4">
                <div class="h-12 w-12 bg-purple-50 text-purple-600 rounded-lg flex items-center justify-center font-bold text-lg border border-purple-100">
                    ğŸ§©
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-gray-900">{{ .Name }}</h3>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200">v{{ .Version }}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">{{ .Description }}</p>
                    <p class="text-xs text-gray-400 mt-2">ID: <span class="font-mono">{{ .ID }}</span> Â· Author: {{ .Author }} Â· Entry: <span class="font-mono bg-gray-50 px-1 rounded">{{ .Entry }}</span></p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- çŠ¶æ€æŒ‡ç¤ºç¯ -->
                {{ if .Active }}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    è¿è¡Œä¸­
                </span>
                {{ else }}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                    å·²ç¦ç”¨
                </span>
                {{ end }}

                <!-- å¼€å…³æŒ‰é’® -->
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer" onchange="togglePlugin('{{.ID}}', this.checked)" {{ if .Active }}checked{{ end }}>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-black"></div>
                </label>
                {{ if not .Active }}
                <button onclick="deletePlugin('{{.ID}}')" class="text-gray-400 hover:text-red-600 transition p-1" title="å¸è½½æ’ä»¶">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
                {{ end }}
            </div>
        </div>
        {{ else }}
        <div class="text-center py-12 bg-white rounded-lg border border-dashed border-gray-300">
            <p class="text-gray-400">æš‚æ— å·²å®‰è£…æ’ä»¶</p>
        </div>
        {{ end }}
    </div>
</div>

<script>
    async function uploadPlugin() {
        const input = document.getElementById('zipInput');
        if (input.files.length === 0) return;
        
        if(!confirm("ç¡®å®šè¦ä¸Šä¼ è¯¥æ’ä»¶å—ï¼Ÿ")) { input.value = ''; return; }

        const formData = new FormData();
        formData.append('plugin_zip', input.files[0]);

        try {
            const res = await fetch('/admin/plugins/upload', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (res.ok) {
                // === ä¿®å¤ç‚¹ï¼šå¢åŠ é»˜è®¤æ–‡æœ¬ï¼Œé˜²æ­¢ undefined ===
                alert(data.message || "å®‰è£…æˆåŠŸ");
                window.location.reload();
            } else {
                alert("å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
            }
        } catch(e) { 
            alert("ç½‘ç»œé”™è¯¯"); 
        }
        input.value = '';
    }

    async function togglePlugin(id, isActive) {
        try {
            const formData = new FormData();
            formData.append('id', id);
            formData.append('active', isActive);

            const res = await fetch('/admin/plugins/toggle', { method: 'POST', body: formData });
            // toggle æ¥å£ä¹‹å‰å¯èƒ½æ²¡è¿”å› messageï¼Œè¿™é‡Œéœ€è¦å¤„ç†
            const data = await res.json().catch(() => ({})); 

            if (!res.ok) {
                alert("æ“ä½œå¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
                // çŠ¶æ€å›æ»š
                window.location.reload();
            } else {
                console.log("Plugin status updated");
                // ç¨ååˆ·æ–°ä»¥æ›´æ–°ç•Œé¢çŠ¶æ€
                setTimeout(() => window.location.reload(), 500);
            }
        } catch(e) {
            alert("ç½‘ç»œé”™è¯¯");
            window.location.reload();
        }
    }

    async function deletePlugin(id) {
        if(!confirm(`âš ï¸ ç¡®å®šè¦å¸è½½å¹¶åˆ é™¤æ’ä»¶ [${id}] å—ï¼Ÿ`)) return;
        
        try {
            const res = await fetch('/admin/plugins/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({'id': id})
            });
            const data = await res.json();
            
            if (res.ok) {
                alert(data.message || "å·²åˆ é™¤");
                window.location.reload();
            } else {
                alert("åˆ é™¤å¤±è´¥: " + (data.error || "æœªçŸ¥é”™è¯¯"));
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    async function reloadPlugins() {
        try {
            const res = await fetch('/admin/plugins/reload', { method: 'POST' });
            const data = await res.json();
            if(res.ok) {
                alert(data.message || "é‡è½½æˆåŠŸ");
                window.location.reload();
            } else {
                alert("é‡è½½å¤±è´¥");
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }
</script>