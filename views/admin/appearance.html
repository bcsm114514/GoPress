<div class="space-y-8">
    
    <!-- 1. é¡¶éƒ¨ï¼šä¸Šä¼ ä¸æ ‡é¢˜ -->
    <div class="flex justify-between items-center">
        <h2 class="font-bold text-xl text-gray-800">å¤–è§‚ç®¡ç†</h2>
        <!-- ä¸Šä¼ è¡¨å• -->
        <form id="uploadForm" class="flex gap-2">
            <input type="file" name="theme_zip" accept=".zip" class="hidden" id="zipInput" onchange="uploadTheme()">
            <label for="zipInput" class="bg-black text-white px-4 py-2 rounded text-sm font-medium hover:bg-gray-800 transition cursor-pointer flex items-center gap-2 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                ä¸Šä¼ ä¸»é¢˜ (.zip)
            </label>
        </form>
    </div>

    <!-- 2. å½“å‰ä¸»é¢˜ -->
    <div>
        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">å½“å‰ä½¿ç”¨</h3>
        {{ range .Themes }}{{ if .IsActive }}
        <div class="bg-white p-6 rounded-xl border border-blue-200 shadow-sm ring-1 ring-blue-100 flex flex-col md:flex-row gap-6">
            <!-- ç¼©ç•¥å›¾åŒºåŸŸ -->
            <div class="w-full md:w-64 h-40 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 overflow-hidden border border-gray-100">
                {{ if .Screenshot }}
                    <!-- å‡è®¾æˆªå›¾åœ¨ä¸»é¢˜æ ¹ç›®å½•ï¼Œé€šè¿‡é™æ€è·¯ç”±è®¿é—® -->
                    <img src="/static/{{.Screenshot}}" class="w-full h-full object-cover">
                {{ else }}
                    <span class="text-4xl">ğŸ¨</span>
                {{ end }}
            </div>
            
            <div class="flex-1 flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-bold text-gray-900">{{ .Name }}</h3>
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full font-mono">v{{ .Version }}</span>
                    </div>
                    <p class="text-gray-500 text-sm mb-2">ä½œè€…ï¼š{{ .Author }}</p>
                    <p class="text-gray-600 text-sm leading-relaxed">{{ .Desc }}</p>
                </div>
                
                <div class="mt-5">
                    <button onclick="openConfig('{{.ID}}')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        è®¾ç½®å¤–è§‚
                    </button>
                </div>
            </div>
        </div>
        {{ end }}{{ end }}
    </div>

    <!-- 3. å¯ç”¨ä¸»é¢˜åˆ—è¡¨ -->
    <div>
        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">å¯ç”¨ä¸»é¢˜</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {{ range .Themes }}{{ if not .IsActive }}
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-md transition flex flex-col h-full">
                <div class="h-32 bg-gray-50 flex items-center justify-center text-gray-300 border-b border-gray-100">
                     <span class="text-3xl">ğŸ“¦</span>
                </div>
                <div class="p-5 flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800">{{ .Name }}</h3>
                        <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">{{ .Version }}</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-4 line-clamp-2">{{ .Desc }}</p>
                    
                    <div class="mt-auto flex gap-3">
                        <button onclick="activateTheme('{{.ID}}')" class="flex-1 bg-black text-white py-1.5 rounded-md text-sm font-medium hover:bg-gray-800 transition">
                            å¯ç”¨
                        </button>
                        <button onclick="openConfig('{{.ID}}')" class="px-3 bg-white border border-gray-300 text-gray-600 py-1.5 rounded-md text-sm font-medium hover:bg-gray-50 transition">
                            è®¾ç½®
                        </button>
                        <button onclick="deleteTheme('{{.ID}}')" class="px-3 bg-white border border-red-200 text-red-500 py-1.5 rounded-md text-sm font-medium hover:bg-red-50 transition" title="åˆ é™¤">
                            ğŸ—‘ï¸
                        </button>

                    </div>
                </div>
            </div>
            {{ end }}{{ end }}
        </div>
    </div>
</div>

<!-- 4. ä¾§æ»‘é…ç½®é¢æ¿ (æŠ½å±‰) -->
<div id="configModal" class="fixed inset-0 z-50 hidden">
    <!-- é®ç½© -->
    <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" onclick="closeConfig()"></div>
    
    <!-- é¢æ¿ -->
    <div class="absolute inset-y-0 right-0 w-full md:w-[500px] bg-white shadow-2xl transform transition-transform duration-300 translate-x-full flex flex-col" id="modalPanel">
        <!-- å¤´éƒ¨ -->
        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
            <div>
                <h3 class="font-bold text-lg text-gray-900">ä¸»é¢˜è®¾ç½®</h3>
                <p class="text-xs text-gray-500 mt-0.5">ä¿®æ”¹åå®æ—¶ç”Ÿæ•ˆ</p>
            </div>
            <button onclick="closeConfig()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- åŠ¨æ€è¡¨å•å®¹å™¨ -->
        <div class="flex-1 overflow-y-auto p-6" id="formContainer">
            <!-- JS å°†åœ¨è¿™é‡Œç”Ÿæˆ Input/Select/Radio -->
            <div class="flex flex-col items-center justify-center h-full text-gray-400">
                <svg class="animate-spin h-8 w-8 mb-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p>æ­£åœ¨è¯»å–é…ç½®...</p>
            </div>
        </div>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="p-5 border-t border-gray-100 flex justify-end gap-3 bg-gray-50/50">
            <button onclick="closeConfig()" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium transition">å–æ¶ˆ</button>
            <button onclick="saveConfig()" id="saveBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium shadow-sm transition flex items-center">
                ä¿å­˜æ›´æ”¹
            </button>
        </div>
    </div>
</div>

<script>
    let currentEditingId = '';
    const modal = document.getElementById('configModal');
    const panel = document.getElementById('modalPanel');
    const formContainer = document.getElementById('formContainer');

    // === ä¸Šä¼ é€»è¾‘ ===
    async function uploadTheme() {
        const input = document.getElementById('zipInput');
        if (input.files.length === 0) return;
        
        if(!confirm("ç¡®å®šè¦ä¸Šä¼ å¹¶å®‰è£…è¯¥ä¸»é¢˜å—ï¼Ÿ")) { input.value = ''; return; }

        const formData = new FormData();
        formData.append('theme_zip', input.files[0]);

        try {
            const res = await fetch('/admin/appearance/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (res.ok) {
                alert(data.message);
                window.location.reload();
            } else {
                alert("å¤±è´¥: " + data.error);
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        input.value = ''; 
    }

    // === æ‰“å¼€é…ç½® (æ ¸å¿ƒï¼šç”Ÿæˆè¡¨å•) ===
    async function openConfig(id) {
        currentEditingId = id;
        modal.classList.remove('hidden');
        setTimeout(() => panel.classList.remove('translate-x-full'), 10);
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        formContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400"><p>åŠ è½½ä¸­...</p></div>';
        
        try {
            const res = await fetch(`/admin/appearance/config/${id}`);
            const data = await res.json();
            
            // è§£æ JSON
            const config = JSON.parse(data.content);
            const settings = config.settings || []; 
            
            if (settings.length === 0) {
                formContainer.innerHTML = '<div class="text-center py-10 text-gray-400">è¯¥ä¸»é¢˜æ²¡æœ‰å¯é…ç½®é¡¹</div>';
                return;
            }

            // === åŠ¨æ€ç”Ÿæˆ HTML ===
            let html = '<form id="dynamicSettingsForm" class="space-y-6">';
            
            settings.forEach(item => {
                // å¦‚æœæ²¡æœ‰ valueï¼Œä½¿ç”¨ default
                const value = (item.value !== undefined && item.value !== "") ? item.value : (item.default || "");
                
                html += `<div>`;
                html += `<label class="block text-sm font-bold text-gray-700 mb-1.5">${item.label}</label>`;
                
                // 1. æ–‡æœ¬æ¡†
                if (item.type === 'text') {
                    html += `<input type="text" name="${item.key}" value="${value}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm transition">`;
                } 
                // 2. å¤šè¡Œæ–‡æœ¬
                else if (item.type === 'textarea') {
                    html += `<textarea name="${item.key}" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm transition">${value}</textarea>`;
                }
                // 3. å•é€‰æ¡† (Radio)
                else if (item.type === 'radio') {
                    html += `<div class="flex gap-4 mt-2">`;
                    (item.options || []).forEach(opt => {
                        const checked = opt === value ? 'checked' : '';
                        html += `
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="${item.key}" value="${opt}" class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${checked}>
                            <span class="ml-2 text-sm text-gray-700">${opt}</span>
                        </label>`;
                    });
                    html += `</div>`;
                }
                // 4. ä¸‹æ‹‰æ¡† (Select)
                else if (item.type === 'select') {
                    html += `<select name="${item.key}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">`;
                    (item.options || []).forEach(opt => {
                        const selected = opt === value ? 'selected' : '';
                        html += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                    html += `</select>`;
                }

                // æè¿°ä¿¡æ¯
                if (item.description) {
                    html += `<p class="mt-1.5 text-xs text-gray-500">${item.description}</p>`;
                }
                html += `</div>`;
            });
            
            html += '</form>';
            formContainer.innerHTML = html;

        } catch(e) {
            console.error(e);
            formContainer.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-lg text-sm">é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚</div>';
        }
    }

    function closeConfig() {
        panel.classList.add('translate-x-full');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // === ä¿å­˜é…ç½® ===
    async function saveConfig() {
        const form = document.getElementById('dynamicSettingsForm');
        if (!form) return;
        
        const formData = new FormData(form);
        formData.append('theme_id', currentEditingId);

        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerHTML;
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        try {
            const res = await fetch('/admin/appearance/save-config', {
                method: 'POST',
                body: formData 
            });
            
            const data = await res.json();
            if (res.ok) {
                btn.innerText = "å·²ä¿å­˜ âœ“";
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                
                setTimeout(() => {
                    closeConfig();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                    
                    // æç¤ºåˆ·æ–°é¢„è§ˆ
                    if (confirm("ä¿å­˜æˆåŠŸï¼\næ˜¯å¦åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœï¼Ÿ")) {
                        // å¦‚æœåœ¨åå°ï¼Œåˆ·æ–°å¯èƒ½çœ‹ä¸å‡ºå‰å°æ•ˆæœï¼Œè·³è½¬é¦–é¡µ
                        window.open('/', '_blank'); 
                    }
                }, 800);
            } else {
                alert("ä¿å­˜å¤±è´¥: " + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch(e) {
            alert("ç½‘ç»œé”™è¯¯");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // å¯ç”¨ä¸»é¢˜
    async function activateTheme(id) {
        if(!confirm(`ç¡®å®šè¦å¯ç”¨ä¸»é¢˜ [${id}] å—ï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨é‡å¯ã€‚`)) return;
        
        const res = await fetch('/admin/appearance/activate', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({'theme_id': id})
        });
        
        if(res.ok) {
            NProgress.start();
            alert("åˆ‡æ¢æˆåŠŸï¼ç‚¹å‡»ç¡®å®šé‡æ–°åŠ è½½é¡µé¢ã€‚");
            setTimeout(() => window.location.reload(), 1500);
        } else {
            alert("åˆ‡æ¢å¤±è´¥");
        }
    }
    async function deleteTheme(id) {
        if(!confirm(`âš ï¸ å±é™©æ“ä½œï¼\nç¡®å®šè¦æ°¸ä¹…åˆ é™¤ä¸»é¢˜ [${id}] å—ï¼Ÿ`)) return;
        
        try {
            const res = await fetch('/admin/appearance/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({'theme_id': id})
            });
            const data = await res.json();
            
            if (res.ok) {
                alert("å·²åˆ é™¤");
                window.location.reload();
            } else {
                alert("åˆ é™¤å¤±è´¥: " + data.error);
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }
</script>